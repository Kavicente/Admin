<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        const socket = io('https://alert-858l.onrender.com');
        socket.on('connect', () => {
            console.log('Connected to WebSocket');
        });

        socket.on('new_user', (user) => {
            fetchUsers(); // Refresh tables on new signup
        });

        socket.on('user_status_updated', (data) => {
            fetchUsers(); // Refresh tables on status update
        });

        socket.on('user_deleted', (data) => {
            fetchUsers(); // Refresh tables on user deletion
        });

        async function loadUsers() {
            try {
                const response = await fetch('/api/admin_accounts', {
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const users = await response.json();
                updateTables(users);
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Failed to load user data: ' + error.message);
            }
        }

        async function fetchUsers() {
            try {
                const response = await fetch('/api/admin_accounts');
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const users = await response.json();
                updateTables(users);
            } catch (error) {
                console.error('Error fetching users:', error);
                alert('Failed to fetch users: ' + error.message);
            }
        }

        function updateTables(users) {
            const allTable = document.getElementById('all-accounts-table').getElementsByTagName('tbody')[0];
            const residentTable = document.getElementById('resident-accounts-table').getElementsByTagName('tbody')[0];
            const barangayTable = document.getElementById('barangay-accounts-table').getElementsByTagName('tbody')[0];
            const agenciesTable = document.getElementById('agencies-accounts-table').getElementsByTagName('tbody')[0];

            allTable.innerHTML = '';
            residentTable.innerHTML = '';
            barangayTable.innerHTML = '';
            agenciesTable.innerHTML = '';

            users.forEach(user => {
                const row = `
                    <tr>
                        <td>${user.source}</td>
                        <td>${user.role}</td>
                        <td>${user.username || user.contact_no}</td>
                        <td>${user.first_name} ${user.middle_name} ${user.last_name}</td>
                        <td>${user.barangay || ''}</td>
                        <td>${user.municipality || ''}</td>
                        <td>${user.status}</td>
                        <td>
                            ${user.source === 'android' && user.role === 'resident' ? `
                                <button onclick="updateStatus('${user.source}', '${user.username}', 'active')">Activate</button>
                                <button onclick="updateStatus('${user.source}', '${user.username}', 'warning')">Warn</button>
                                <button onclick="updateStatus('${user.source}', '${user.username}', 'suspended')">Suspend</button>
                                <button onclick="deleteUser('${user.source}', '${user.username}')">Delete</button>
                            ` : user.source === 'web' ? `
                                <button onclick="updateStatus('${user.source}', '${user.contact_no}', 'active')">Activate</button>
                                <button onclick="updateStatus('${user.source}', '${user.contact_no}', 'warning')">Warn</button>
                                <button onclick="updateStatus('${user.source}', '${user.contact_no}', 'suspended')">Suspend</button>
                                <button onclick="deleteUser('${user.source}', '${user.contact_no}')">Delete</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
                allTable.insertAdjacentHTML('beforeend', row);
                if (user.source === 'android' && user.role === 'resident') {
                    residentTable.insertAdjacentHTML('beforeend', row);
                }
                if (user.role === 'barangay') {
                    barangayTable.insertAdjacentHTML('beforeend', row);
                }
                if (['cdrrmo', 'pnp', 'bfp'].includes(user.role)) {
                    agenciesTable.insertAdjacentHTML('beforeend', row);
                }
            });
        }

        // Create user
        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                username: formData.get('username'),
                contact_no: formData.get('contact_no'),
                role: formData.get('role')
            };
            try {
                const response = await fetch('/api/admin_create_user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                alert('User created successfully');
                fetchUsers(); // Refresh table
            } catch (error) {
                console.error('Error creating user:', error);
                alert('Failed to create user: ' + error.message);
            }
        });

        async function updateStatus(source, identifier, status) {
            try {
                const endpoint = status === 'warning' ? '/api/admin_warn' : status === 'suspended' ? '/api/admin_suspend' : '/api/update_user_status';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source, identifier, status })
                });
                if (response.ok) {
                    alert(`User ${status} successfully`);
                    fetchUsers();
                } else {
                    const errorData = await response.json();
                    alert(`Failed to update status: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Error updating status: ' + error.message);
            }
        }

        async function deleteUser(source, identifier) {
            if (confirm('Are you sure you want to delete this user?')) {
                try {
                    const response = await fetch('/api/admin_delete_user', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ source, identifier })
                    });
                    if (response.ok) {
                        alert('User deleted successfully');
                        fetchUsers();
                    } else {
                        const errorData = await response.json();
                        alert(`Failed to delete user: ${errorData.error}`);
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('Error deleting user: ' + error.message);
                }
            }
        }

        function showTab(tabId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        window.onload = () => {
            fetchUsers();
            showTab('all-accounts');
        };
    </script>
</head>
<body>
    <div class="sidebar">
        <nav>
            <ul>
                <li><a href="#" onclick="showTab('all-accounts')" id="tab-all-accounts" class="tab active">All Accounts</a></li>
                <li><a href="#" onclick="showTab('resident-accounts')" id="tab-resident-accounts" class="tab">Resident Accounts</a></li>
                <li><a href="#" onclick="showTab('barangay-accounts')" id="tab-barangay-accounts" class="tab">Barangay Accounts</a></li>
                <li><a href="#" onclick="showTab('agencies-accounts')" id="tab-agencies-accounts" class="tab">Agencies Accounts</a></li>
                <li><a href="{{ url_for('logout') }}"><span>ðŸšª</span> Log Out</a></li>
            </ul>
        </nav>
    </div>
    <div class="main-content">
        <button class="toggle-btn" onclick="document.querySelector('.sidebar').classList.toggle('open'); document.querySelector('.main-content').classList.toggle('shifted');">â˜°</button>
        <header>
            <h1 class="h1">Admin Dashboard</h1>
        </header>
        <div class="section" id="all-accounts">
            <h2>All Accounts</h2>
            <table id="all-accounts-table">
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>Role</th>
                        <th>Identifier</th>
                        <th>Name</th>
                        <th>Barangay</th>
                        <th>Municipality</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="section hidden" id="resident-accounts">
            <h2>Resident Accounts</h2>
            <table id="resident-accounts-table">
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>Role</th>
                        <th>Identifier</th>
                        <th>Name</th>
                        <th>Barangay</th>
                        <th>Municipality</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="section hidden" id="barangay-accounts">
            <h2>Barangay Accounts</h2>
            <table id="barangay-accounts-table">
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>Role</th>
                        <th>Identifier</th>
                        <th>Name</th>
                        <th>Barangay</th>
                        <th>Municipality</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="section hidden" id="agencies-accounts">
            <h2>Agencies Accounts</h2>
            <table id="agencies-accounts-table">
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>Role</th>
                        <th>Identifier</th>
                        <th>Name</th>
                        <th>Barangay</th>
                        <th>Municipality</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</body>
</html>
